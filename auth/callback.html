<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Login - FlowCast Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .blob {
            position: absolute;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-white h-screen flex items-center justify-center overflow-hidden relative">

    <div class="blob bg-purple-600 w-96 h-96 rounded-full top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div
        class="blob bg-indigo-600 w-96 h-96 rounded-full bottom-0 right-0 translate-x-1/3 translate-y-1/3 animation-delay-2000">
    </div>

    <div
        class="bg-slate-800/50 backdrop-blur-xl border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
        <div class="mb-6 flex justify-center">
            <div
                class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center animate-pulse">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.2-2.85.577-4.147l.36-.999">
                    </path>
                </svg>
            </div>
        </div>

        <h2 class="text-2xl font-bold mb-2">Connecting to TikTok...</h2>
        <p class="text-slate-400 mb-6">Please wait while we verify your credentials.</p>

        <div id="debug-info" class="text-xs text-slate-500 bg-slate-900/50 p-3 rounded font-mono break-all">
            Initializing...
        </div>
    </div>

    <script>
        // REPLACE WITH YOUR NGROK/BACKEND URL
        // IMPORTANT: If this page is on HTTPS (GitHub Pages), this MUST be HTTPS (Ngrok)
        const BACKEND_URL = 'https://api.innovator-gate.jp';

        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const state = params.get("state");
        const error = params.get("error");
        const debugEl = document.getElementById("debug-info");

        if (code) {
            debugEl.innerText = `Auth Code Received: ${code.substring(0, 10)}...`;

            // Send code to backend to exchange for token
            fetch(`${BACKEND_URL}/api/exchange_token`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code: code })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        debugEl.innerText = "Success! Redirecting...";
                        debugEl.classList.add("text-green-400");

                        // Save user info to local storage for the main page
                        localStorage.setItem('tiktok_user', JSON.stringify(data.user));

                        // Redirect back to main page
                        setTimeout(() => {
                            // Go back to the root index.html (assuming structure is /auth/callback.html)
                            window.location.href = "../index.html";
                        }, 1000);
                    } else {
                        debugEl.innerText = `Error: ${JSON.stringify(data)}`;
                        debugEl.classList.add("text-red-400");
                    }
                })
                .catch(err => {
                    debugEl.innerText = `Connection Error: ${err.message}. Ensure Backend is running and accessible.`;
                    debugEl.classList.add("text-red-400");
                });

        } else if (error) {
            debugEl.innerText = `TikTok Error: ${error}`;
            debugEl.classList.add("text-red-400");
        } else {
            debugEl.innerText = "No code found in URL.";
        }
    </script>
</body>

</html>

